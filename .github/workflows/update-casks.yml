name: Automatically brew bump-cask-pr

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  update-casks:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Tap this repository
        run: |
          tap_path="$(brew --repo)/Library/Taps/bdeb1337"
          mkdir -p "$tap_path"
          # Remove if exists (whether file, directory, or symlink)
          rm -rf "$tap_path/homebrew-tap" 2>/dev/null || true
          # Create symlink instead of directory
          ln -s "$GITHUB_WORKSPACE" "$tap_path/homebrew-tap"

      - name: Update Casks
        run: |
          for cask_file in Casks/*.rb; do
            cask_name=$(basename "$cask_file" .rb)
            echo "Checking bdeb1337/tap/$cask_name..."
            
            # Check if update is available - strip ANSI codes from output
            livecheck_output=$(brew livecheck --cask "bdeb1337/tap/$cask_name" 2>&1 | sed 's/\x1b\[[0-9;]*m//g')
            echo "$livecheck_output"
            
            # Check if output contains version upgrade pattern (e.g., "0.1.3 ==> 0.2.0")
            if echo "$livecheck_output" | grep -q "==>"; then
              echo "Update available for $cask_name"
              
              # Extract the new version and strip any non-version characters
              arrow_line=$(echo "$livecheck_output" | grep "==>")
              echo "DEBUG: Arrow line: '$arrow_line'"
              new_version=$(echo "$arrow_line" | awk '{print $NF}' | tr -cd '0-9.')
              echo "DEBUG: Extracted version: '$new_version'"
              
              # Check if version was extracted
              if [ -z "$new_version" ]; then
                echo "ERROR: Failed to extract version from livecheck output"
                continue
              fi
              
              # Use bump-cask-pr with write-only flag and version
              echo "Running: brew bump-cask-pr --write-only --no-audit --version=$new_version bdeb1337/tap/$cask_name"
              if brew bump-cask-pr --write-only --no-audit --version="$new_version" "bdeb1337/tap/$cask_name"; then
                git add "$cask_file"
                git commit -m "chore: auto-update $cask_name to $new_version" || true
              else
                echo "Failed to bump $cask_name"
                continue
              fi
            else
              echo "No update available for $cask_name"
            fi
          done
          
          # Push changes if any
          git push origin main || echo "No updates to push"