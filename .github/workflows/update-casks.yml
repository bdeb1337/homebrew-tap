name: Automatically brew bump-cask-pr

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  update-casks:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Tap this repository
        run: |
          # Remove tap directory if it exists to avoid conflicts
          rm -rf "$(brew --repo)/Library/Taps/bdeb1337/homebrew-tap" 2>/dev/null || true
          # Tap from local path
          brew tap bdeb1337/tap "$GITHUB_WORKSPACE"

      - name: Update Casks
        run: |
          for cask_file in Casks/*.rb; do
            cask_name=$(basename "$cask_file" .rb)
            echo "Checking bdeb1337/tap/$cask_name..."
            
            # Check if update is available with verbose output
            livecheck_output=$(brew livecheck --cask "bdeb1337/tap/$cask_name" 2>&1)
            echo "$livecheck_output"
            
            if echo "$livecheck_output" | grep -qE "(newer version|is outdated)"; then
              echo "Update available for $cask_name"
              
              # Use bump-cask-pr with write-only flag
              if brew bump-cask-pr --write-only --no-audit "bdeb1337/tap/$cask_name"; then
                git add "$cask_file"
                git commit -m "chore: auto-update $cask_name" || true
              else
                echo "Failed to bump $cask_name"
              fi
            else
              echo "No update available for $cask_name"
            fi
          done
          
          # Push changes if any
          if git diff --cached --quiet; then
            echo "No updates to push"
          else
            git push origin main
          fi
      
      - name: Cleanup tap
        if: always()
        run: |
          brew untap bdeb1337/tap 2>/dev/null || true